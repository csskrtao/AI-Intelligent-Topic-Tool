# 图片预览显示问题修复

## 问题描述
上传图片后，原图预览无法正常显示。

## 问题原因

### 1. 后端返回的字段名不匹配
- **后端返回**: `image_path` (文件系统路径)
- **前端期望**: `image_url` (可访问的 URL)

### 2. 图片 URL 路径问题
- 后端返回相对路径: `/api/image/{filename}`
- 前端需要完整 URL: `http://localhost:8000/api/image/{filename}`
- 前端运行在 Vite 开发服务器（不同端口），无法直接访问相对路径

## 修复方案

### 修改 1: 后端返回正确的字段名和 URL
**文件**: `backend_api.py`

```python
# 修改 OCRResponse 模型
class OCRResponse(BaseModel):
    success: bool
    message: str
    questions: List[QuestionResponse]
    image_url: str  # ✅ 改为 image_url

# 修改返回数据
image_url = f"/api/image/{temp_file_path.name}"  # ✅ 构造 URL
return OCRResponse(
    success=True,
    message=f"成功识别并分割出 {len(questions)} 道题目",
    questions=question_responses,
    image_url=image_url  # ✅ 返回 image_url
)
```

### 修改 2: 前端处理相对路径，转换为完整 URL
**文件**: `src/App.jsx`

```javascript
const API_BASE_URL = 'http://localhost:8000';

const handleUploadSuccess = (data) => {
  // 将相对路径转换为完整 URL
  const fullImageUrl = data.image_url.startsWith('http')
    ? data.image_url
    : `${API_BASE_URL}${data.image_url}`;

  console.log('图片 URL:', fullImageUrl);
  setImageUrl(fullImageUrl);
  setQuestions(data.questions);
  message.success(`图片识别成功！识别到 ${data.questions.length} 道题目`);
};
```

### 修改 3: 增强图片加载错误处理
**文件**: `src/components/ImageViewer.jsx`

```javascript
const ImageViewer = ({ imageUrl }) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(false);

  const handleImageLoad = () => {
    console.log('图片加载成功:', imageUrl);
    setLoading(false);
  };

  const handleImageError = (e) => {
    console.error('图片加载失败:', imageUrl, e);
    setError(true);
    setLoading(false);
  };

  return (
    <Card title="原图预览">
      {loading && <Spin tip="加载图片中..." />}
      {error && <Alert message="图片加载失败" type="error" />}
      <img 
        src={imageUrl}
        onLoad={handleImageLoad}
        onError={handleImageError}
        style={{ display: loading || error ? 'none' : 'block' }}
      />
    </Card>
  );
};
```

## 测试步骤

1. ✅ 重启后端服务: `python backend_api.py`
2. ✅ 刷新前端页面
3. ✅ 上传测试图片 `test.png`
4. ✅ 检查浏览器控制台日志
5. ✅ 验证图片是否正常显示

## 预期结果

- 上传成功后，左侧显示原图预览
- 右侧显示识别出的题目列表
- 控制台输出调试信息：
  - 上传成功，数据: {...}
  - 图片 URL: http://localhost:8000/api/image/xxx.png
  - 题目数量: N
  - 图片加载成功: http://localhost:8000/api/image/xxx.png

## 相关文件

- `backend_api.py` - 后端 API
- `src/App.jsx` - 主应用组件
- `src/components/ImageViewer.jsx` - 图片预览组件
- `src/services/api.js` - API 服务

## 修复时间
2025-11-07

---

# DeepSeek OCR 响应格式说明

## 标记含义

DeepSeek OCR API 返回的内容包含特殊标记，用于标识文本和坐标信息：

### 格式示例

```
<|ref|>text<|/ref|><|det|>[[36, 25, 912, 185]]<|/det|>
42.(10分)现有 \(n(n>100000)\) 个数保存在一维数组M中...
```

### 标记说明

1. **`<|ref|>text<|/ref|>`**
   - 表示这是一个文本块的引用标记
   - 固定内容为 `text`
   - 用于标识文本块的开始

2. **`<|det|>[[x1, y1, x2, y2]]<|/det|>`**
   - 表示文本的边界框坐标（Detection）
   - 格式：`[[左上角x, 左上角y, 右下角x, 右下角y]]`
   - 例如：`[[36, 25, 912, 185]]` 表示：
     - 左上角坐标：(36, 25)
     - 右下角坐标：(912, 185)
   - 这些坐标可用于：
     - 图片切割
     - 文本块排序
     - 布局分析

3. **实际文本内容**
   - 标记后面的行是实际识别的文本
   - 可能包含多行
   - 可能包含 LaTeX 公式（如 `\(n>100000)\)`）

## 解析处理

### 解析函数

在 `src/utils.py` 中实现了 `parse_deepseek_ocr_response()` 函数：

```python
def parse_deepseek_ocr_response(content: str) -> List[Dict[str, any]]:
    """
    解析 DeepSeek OCR API 返回的内容

    Returns:
        List[Dict]: 解析后的文本块列表，每个包含：
        - 'text': 纯文本内容（已清理标记）
        - 'box': 边界框坐标 [x1, y1, x2, y2]
    """
```

### 清理函数

`clean_ocr_text()` 函数用于移除所有标记，获取纯文本：

```python
def clean_ocr_text(text: str) -> str:
    """
    清理 OCR 文本中的特殊标记

    Returns:
        str: 清理后的纯文本
    """
```

## 使用场景

1. **题目分割**
   - 使用坐标信息对文本块进行排序
   - 按阅读顺序组织题目

2. **图片切割**
   - 根据边界框坐标切割原图
   - 生成单独的题目图片

3. **布局分析**
   - 识别题目的空间位置关系
   - 判断是否属于同一题目

## 注意事项

- 标记中的 `|` 字符在正则表达式中不需要转义（在字符类外）
- 坐标是相对于原图的像素坐标
- 文本可能跨多行，需要正确拼接
- 某些文本块可能没有坐标信息（使用 [0, 0, 0, 0] 作为占位）

