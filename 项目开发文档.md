### **AI 智能切题工具 - 项目开发文档**

*   **版本**: 1.0
*   **创建日期**: 2023年10月27日
*   **项目负责人**: [你的名字]

---

#### **1. 项目概述**

##### **1.1 项目目标**
开发一款桌面或Web应用软件，旨在帮助用户快速、智能地处理包含多道题目的文件（如试卷、练习册的图片或PDF）。软件能够自动识别、分割文件中的每一道题目，并允许用户将单道题目以文本或图片的形式独立保存，极大地提升题库整理和内容管理的效率。

##### **1.2 核心价值**
*   **效率提升**：将手动截图、复制粘贴题目的繁琐工作自动化，为教育工作者、学生和内容创作者节省大量时间。
*   **内容数字化**：轻松将纸质题目或图片题目转化为可编辑、可检索的数字化资源。
*   **题库构建基础**：为建立个人或机构的结构化题库提供强大的内容采集工具。

##### **1.3 目标用户**
*   教师、教研员
*   学生（用于整理错题本）
*   在线教育内容开发者
*   出版社及图书编辑

---

#### **2. 功能需求规格 (Functional Requirements)**

我们将功能按优先级分为 P0, P1, P2，以指导敏捷开发。

##### **P0: 核心功能 (MVP - 最小可行产品)**
1.  **文件上传**:
    *   支持单张图片上传，格式包括 `.jpg`, `.png`, `.bmp`。
2.  **OCR 处理**:
    *   集成并调用 **DeepSeek OCR API**。
    *   将上传的图片发送至API，并获取包含文字和坐标信息的JSON返回结果。
3.  **题目自动分割**:
    *   实现基于规则的分割算法。对OCR返回的文本块进行排序后，使用正则表达式匹配题号（如 `1.`、`2、`、`(1)` 等）作为题目起点，进行初步分割。
4.  **预览与手动校准**:
    *   提供一个双栏视图：左侧显示原始上传图片，右侧以列表形式展示自动分割后的题目。
    *   用户可以点选右侧的题目列表项。
    *   提供 **合并** 功能：允许用户选择连续的多项，将其合并为一道题。
    *   提供 **拆分** 功能：允许用户在某道题的文本内容中，通过插入光标或选择文本的方式将其拆分为两道或多道题。
5.  **题目导出**:
    *   **导出为文本 (`.txt`)**: 将选中的单道或多道题目，分别保存为独立的文本文件。
    *   **导出为图片 (`.png`)**: 根据题目包含的所有文本块坐标，计算出包围盒（Bounding Box），从原始图片中精确裁剪出该题目的区域，并保存为图片文件。

##### **P1: 重要功能 (V1.1 版本)**
1.  **PDF 文件支持**:
    *   支持上传 `.pdf` 文件。
    *   后端使用 `pdf2image` 等库将PDF的每一页转换为图片，然后分发给OCR模块进行处理。
2.  **批量处理**:
    *   支持用户一次性上传多张图片或一个多页的PDF文件，软件自动完成所有页面的识别和分割。
3.  **UI/UX 优化**:
    *   在预览界面，当鼠标悬停或点击右侧题目列表项时，在左侧原始图片上高亮显示该题目对应的区域。

##### **P2: 扩展功能 (V2.0 及未来规划)**
1.  **本地题库管理**:
    *   将分割并校对完成的题目保存到本地数据库（如 SQLite）。
    *   支持对已保存的题目进行搜索、编辑和打标签（如科目、年级、知识点）。
2.  **高级导出选项**:
    *   支持导出为结构化数据，如 `JSON` 或 `CSV`，方便导入其他系统。
3.  **公式识别集成**:
    *   调研并考虑集成专门的公式识别API，对题目中的数学/化学公式进行结构化识别，并以 LaTeX 等格式保存。

---

#### **3. 技术架构与选型**

*   **应用类型**: 建议作为 **桌面应用程序** 启动（使用 Python + PyQt/PySide），优点是数据本地处理、隐私性好、响应快。Web应用可作为未来方向。
*   **核心语言**: **Python**
*   **核心库/框架**:
    *   **后端/逻辑层**:
        *   `requests`: 用于调用 DeepSeek OCR API。
        *   `Pillow (PIL)`: 用于图像处理，特别是题目的精确裁剪。
        *   `re` (标准库): 用于实现基于规则的题目分割算法。
        *   `pdf2image`: 用于处理PDF文件。
    *   **GUI 框架 (桌面端)**:
        *   `PyQt6` 或 `PySide6`: 功能强大且成熟的跨平台GUI框架。
*   **外部服务依赖**:
    *   **DeepSeek OCR API**: 项目的核心依赖。API Key 需安全管理，不能硬编码在代码中，应通过配置文件或环境变量加载。

---

#### **4. 核心工作流程与算法设计**

1.  **用户上传文件 (图片/PDF)**
    *   若为PDF，逐页转为图片。后续流程以单张图片为单位。

2.  **调用 OCR API**
    *   读取图片文件，编码为 Base64 字符串。
    *   构造符合 DeepSeek API 要求的 JSON 请求体，发送 POST 请求。
    *   接收并解析返回的 JSON 数据，提取 `ocr_contents` 列表，其中包含 `text` 和 `box`。

3.  **OCR 结果预处理**
    *   对 `ocr_contents` 列表进行 **逻辑排序**，以模拟人类阅读顺序：主要按 `box` 的 `y` 坐标升序，对于 `y` 坐标相近的行，再按 `x` 坐标升序。

4.  **题目分割算法**
    *   **输入**: 排序后的文本块列表 `sorted_blocks`。
    *   **过程**:
        1.  初始化一个空列表 `questions` 和一个临时的题目内容列表 `current_question_blocks`。
        2.  遍历 `sorted_blocks` 中的每一个 `block`。
        3.  使用正则表达式（例如 `^\s*(\d+|[一二三四五六七八九十]+)[\.、．]\s*.*`）检查 `block['text']` 是否符合题号的模式。
        4.  **如果匹配成功 (是新题号)**:
            *   若 `current_question_blocks` 不为空，则将其内容（文本和坐标集合）作为一个完整的题目存入 `questions` 列表。
            *   清空 `current_question_blocks`，并将当前这个 `block` 作为新题目的第一个块加入。
        5.  **如果匹配失败 (是题目内容)**:
            *   将当前 `block` 追加到 `current_question_blocks` 中。
        6.  遍历结束后，将最后一组 `current_question_blocks` 存入 `questions`。
    *   **输出**: `questions` 列表，每个元素是一道题，包含其所有文本块的集合。

5.  **导出逻辑**
    *   **导出为文本**: 拼接一道题内所有文本块的 `text` 字段。
    *   **导出为图片**:
        1.  获取一道题内所有文本块的 `box` 坐标。
        2.  计算能完全包围这些 `box` 的最小矩形：`min_x = min(all_x1)`, `min_y = min(all_y1)`, `max_x = max(all_x2)`, `max_y = max(all_y2)`。
        3.  使用 Pillow 库，从原始图片上裁剪出 `(min_x, min_y, max_x, max_y)` 这个区域。

---

#### **5. 开发阶段规划 (Roadmap)**

*   **第一阶段: MVP 开发 (预计 4 周)**
    *   **Week 1**: 技术调研，完成 DeepSeek API 的封装与测试。搭建项目基本框架。
    *   **Week 2**: 实现 P0 核心功能中的文件上传、OCR调用、分割算法。完成基本的数据结构设计。
    *   **Week 3**: 开发预览与手动校准界面 (GUI)，实现合并与拆分的前端与后端逻辑。
    *   **Week 4**: 实现题目导出功能（文本和图片）。进行内部测试、Bug修复，完成MVP版本。

*   **第二阶段: 功能增强 (MVP 发布后)**
    *   根据用户反馈，迭代优化分割算法的正则表达式库。
    *   逐步开发 P1 级别的功能，如 PDF 支持和批量处理。
    *   进行 UI/UX 体验优化。

*   **第三阶段: 产品化**
    *   规划和设计 P2 级别的功能，如本地题库管理系统。

---

#### **6. 关键风险与注意事项**

*   **API 依赖**: DeepSeek API 的稳定性、响应时间和费用是项目的外部依赖风险。需要做好错误处理和重试机制。
*   **分割准确率**: 自动分割算法无法做到100%准确，因此 **手动校准功能是产品的核心价值之一**，必须保证其体验流畅。
*   **性能问题**: 处理高分辨率大图或多页PDF时，OCR和图像处理可能耗时较长，需要提供清晰的进度反馈给用户。
*   **API Key 安全**: 必须妥善保管 API Key，避免泄露。

---

请开发团队以此文档为纲要，开展后续的设计与开发工作。预祝项目顺利！